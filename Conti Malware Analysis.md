# Conti Malware Analysis

Analysis a sample and source code of  `CONTI` ransomware on the internet and try to analyze it behaviors both static and dynamic way, source code review. 

# Introduction

## Overview

`CONTI` is a ransomware that uses the double extortion model to force their victim pay the ransom. In essence, the attacker will not only lock up a victim’s files by encrypting them and demand ransom for their decryption, but they will also steal file and threaten to publish them on a website or otherwise leak them if their initial ransom request is not met. The model is not novel, as it has been introduction by MAZE and then used in other ransomware campaigns such as `REvil, Ragnar,..`

The basic phases of the means of infiltration, with are utilized by CONTI, are illustrated in figure

![Overview of the CONTI Infiltration Process](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled.png)

Overview of the CONTI Infiltration Process

In principle, infiltration starts with the attackers sending a phishing email to the potential victim. Once the victim opens the email and unbeknown to him/her runs the malicious dropper. the attackers get initial access to the victim’s network and can execute code. Having gained initial access, the attackers try to establish a better foothold and perform lateral movement to perform the aimed objectives, with the end goal being to hold the victim hostage and force the victim to pay a ransom to regain access to his/her data, which at the final stage of the attack are the encrypted by CONTI, to prevent publication/selling of his/her data

Next, the attackers try to brute force credentials. perform an LSASS memory dump, or even exploit some existing vulnerabilities to elevate privileges. Once this is done, the attackers try to turn off infected/infiltrated system’s antivirus solution (AVs) as well as other existing security mechanisms. Subsequently, the attackers will scan the network for the other servers/workstations to gain additional access/ 

Then, the infected/infiltrated hosts are attached to a server controlled by the attackers. Afterwards, the attackers try to upload the exfiltrated data to a cloud service

Finally, the attackers launch the ransomware “encryptor” to lock the victim’s files. After the encryption, CONTI leaves a “README” file in each folder that it encrypts, which notifies the victim of the attack that his/her data have been encrypted and provides means to contact the CONTI team to pay the ransom and get decryption software. In prior versions, the team used email addresses as means communication. However, the developed a portal later, where users could contact CONTI using an ID that they were assigned. In this cases, the template of the ransomware notice is in the form of picture

![A Sample of the Ransomware Notice Left by CONTI](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%201.png)

A Sample of the Ransomware Notice Left by CONTI

Click [here](/Conti_demo.md) if you want to see when Conti run
## Technical Details

Unique feature of Conti are:

- Conti uses multiple anti-analysis techniques including unique **strings encoding routine** that applies 277 different algorithms - one per string. This kind of encoding is mainly to hide Windows API calls uses by Conti
- Conti allow executing command line argument to directly encrypt the local hard drives or local share network, and specific targeted IP address. Attacker can directly with command line arguments as well as have ability the to execute Conti independently.
- Conti **uses `vssadmin` to deleted, and resize windows volume shadow copies** to disable recovery on the local system
- Conti supports multithreaded operation; it uses **32 simultaneous encryption
CPU threads** to speed up the encryption process. The malware uses the
`CreateIoCompletionPort()` call to create 32 instances of this worker thread
into memory to wait for data. After file is listing completed, they are fed to the
threads for immediate encryption.
- Conti also abuses Windows Restart Manager to close applications and
services currently running to make them available for encryption to maximize
the damage

# ****IOCS****

****Conti Ransomware comes in the form of a 32-bit PE file (either `.exe or .dll`)**

**Sample:** [https://bazaar.abuse.ch/sample/d7573284c29cf5f68bb64860f1be0a696c852678fac36f176fd88f555ed853f2/](https://bazaar.abuse.ch/sample/d7573284c29cf5f68bb64860f1be0a696c852678fac36f176fd88f555ed853f2/)

**SHA256 hash:** `d7573284c29cf5f68bb64860f1be0a696c852678fac36f176fd88f555ed853f2`

**SHA3-384 hash:** `47e3e554139eb8e44c44991edd6ee751446c10b8712cb755e7adbef881f023b2296958d54ae0c85acc35719de3faf698`

**SHA1 hash:** `0ae36846ff75ee88660bfe2d9f59f5b49564d3c0`

**MD5 hash:** `31656fb93e948d7c349457d7f5c6dfec`

![VirusTotal result](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%202.png)

VirusTotal result

## Static

The ransomware only has ***Kernel32.dll, User32.dll and WS2_32.dll*** as visible imported DLLs

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%203.png)

However, it does dynamically resolve a lot of DLLs

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%204.png)

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%205.png)

Here is the full list of the imported DLLs.

- **Kernel32.dll**
- **Ntdll.dll**
- **Ole32.dll**
- **Shell32.dll**
- **Ws2_32.dll**
- **Shlwapi.dll**
- **Advapi32.dll**
- **Iphlpapi.dll**
- **Rstrtmgr.dll**
- **Netapi32.dll**
- **OleAut32_dll**
- **User32.dll**

# Code analysis

## Structure

The source code is a Visual Studio solution (contains conti_v3.sln):

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%206.png)

That allows anyone with access to compile the ransomware locker: 

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%207.png)

and `decryptor`: 

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%208.png)

## AV engines evasion:

Conti is expertly written malware, which must mention how it evades AV tools and hides its activity.

To see the mechanism of communication with `WinAPI` in the folder `api`: 

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%209.png)

First of all see at the file `getapi.cpp`:

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2010.png)

As you can see, to convert RVA (Relative Virtual Address) to VA (Virtual Address) conti used this macro.

Then, function `GetApiAddr`which find Windows API function address by comparing it’s hash:

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2011.png)

This is a simple but efficient technique for hiding `WinAPI` calls. It is **calling functions by hash names.** This main idea is create code where we find `WinAPI` function address by it’s hashing name via enumeration exported `WinAPI` functions

In the loop, we will look at and compare the hash passed to our function with the hashes of the functions in the export table and, as soon as we find a match, exit the loop

### What hashing algorithm is used by Conti?

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2012.png)

*`MurmurHash`* is a non-cryptographic hash function and was [written by Austin Appleby](https://github.com/aappleby/smhasher/blob/master/src/MurmurHash3.cpp)

## Threading

As noted above, Conti supports multithreaded

Each thread allocates its own buffer for the upcoming encryption and initialize its own cryptography context through the `CryptAcquireContext API` and an RSA public key

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2013.png)

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2014.png)

Each thread waits in an infinite loop for a task in the `TaskList`queue. 

## Encryption

The encryption for a specific file starts with a random key generation using the  `CryptGenRandom API`:

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2015.png)

And as you can see, Conti used [ChaCha](https://en.wikipedia.org/wiki/Salsa20) stream cipher 

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2016.png)

`CheckForDataBases` method is invoked to check for a possible full or partial encryption:

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2017.png)

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2018.png)

And `CheckForVirtualMachines` method is invoked to check for a possible partial encryption (`20%`):

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2019.png)

In other cases, the following pattern is followed:

- If the file size is lower than `1048576 bytes (1.04 GB)` - perform a full encryption
- If the file size is `< 5242880 bytes (5.24 GB)` and `> 1048576 bytes (1.04 GB)` - partial encryption: only headers
- Else, `50%` partial encryption:

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2020.png)

When the encryption mode is `ALL_ENCRYPT`or `NETWORK_ENCRYPT`, the malware retrieves info about network.

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2021.png)

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2022.png)

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2023.png)

`GetCurrentIpAddress` is just get info about current IP address:

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2024.png)

Function `GetSubnets` uses `GetIpNetTable` API which is called to restore the ARP table of the infected system. 

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2025.png)

For each entry the specified IPv4 addresses are checked against the following masks:

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2026.png)

Function `ScanHosts`tries a connection to IPv4 on the SMB port (445) using the TCP protocol:

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2027.png)

If connection is successful, saves the valid IP’s via `AddHost`:

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2028.png)

In `HostHandler` 

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2029.png)

And `PortScanHandler`

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2030.png)

`HostHandler`waits for some valid IP in the IP’s queue and for each IP enum the shares using the `NetShareEnum`API:

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2031.png)

And `PortScanHandler`repeat the scan via `ScanHosts`each `30`sec

> In a nutshell, the process goes like this:
1. Add `172.*, 192.168.*, 10.*, 169.*` subnet addresses to queue
2. Create two threads.
3. First thread via `HostHandler` enum the shares.
4. Second thread via `PortScanHandler` tries to connect `SMB 445` port, for each successfully connection, saves valid IPs and scan every `30` sec:
> 

## O**bfuscation**

In addition, an interesting module was found in the source codes

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2032.png)

Which can generate obfuscated code via [ADVObfuscator](https://github.com/andrivet/ADVobfuscator).

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2033.png)

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2034.png)

## P**rocess killer**

The logic of the `prockiller.cpp`is simple. It enum through all processes and if it’s not equal to `explorer.exe`then adds it’s PID to the queue:

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2035.png)

## Filesystem

In the `filesystem`module there is a function `filesystem::EnumirateDrives`which, as the name implies, scan drives:

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2036.png)

It uses `GetLogicalDriveStringsW`API.

The logic of this function is used in the final enumeration during encryption. The malware uses a whitelist for both directories and files to avoid the encryption of unnecessary data. The following directories names and file names are avoided during the enumeration process:

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2037.png)

![Untitled](Conti%20Malware%20Analysis%20c219e073ff0f432ba7a5e5649f44b15e/Untitled%2038.png)

### References

 - [https://chuongdong.com/reverse engineering/2020/12/15/ContiRansomware/](https://chuongdong.com/reverse%20engineering/2020/12/15/ContiRansomware/)

 - [https://twitter.com/contileaks/status/1505433648023146499](https://twitter.com/contileaks/status/1505433648023146499)
 - [https://github.com/aappleby/smhasher/blob/master/src/MurmurHash3.cpp](https://github.com/aappleby/smhasher/blob/master/src/MurmurHash3.cpp)
 - [https://sequretek.com/wp-content/uploads/2018/10/Sequretek-Advisory-1-Conti-Ransomware.pdf](https://sequretek.com/wp-content/uploads/2018/10/Sequretek-Advisory-1-Conti-Ransomware.pdf)
